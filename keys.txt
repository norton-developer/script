console.log("--- BLOODMOON MEGA SCRIPT v12.0 FULL EDITION ---");
console.log("   –ú–æ–¥—É–ª—å–Ω—ã–π | –°–Ω–∏—Ñ—Ñ–µ—Ä | –ü—Ä–µ—Å–µ—Ç—ã | Farm | Anti-AFK");

var moduleName = "libMyGame.so";
var base = Module.findBaseAddress(moduleName);

var CONFIG = {
    version: "12.0",
    sniffEnabled: false,
    farmEnabled: false,
    antiafkEnabled: false,
    zoneKickEnabled: false,
    giftTarget: "cyberDance",
    giftEnabled: true,
    currentRoom: "",
    myPlayerId: "",
    presets: {} // { "cool": {ht: 5, hc: 12, ...} }
};

var pinnedMemory = [];
function pinMem(ptr) {
    pinnedMemory.push(ptr);
    if (pinnedMemory.length > 5000) pinnedMemory.shift();
    return ptr;
}
setInterval(() => { pinnedMemory = []; }, 30000); // –∞–≤—Ç–æ-–æ—á–∏—Å—Ç–∫–∞

// ====================== UTILS ======================
function readStdString(addr) {
    if (!addr || addr.isNull()) return "";
    try {
        var b = addr.readU8();
        if ((b & 1) === 0) return addr.add(1).readUtf8String(b >> 1);
        return addr.add(16).readPointer().readUtf8String();
    } catch(e) { return ""; }
}

function writeStr(addr, text) {
    try {
        for (var i = 0; i < 32; i++) addr.add(i).writeU8(0);
        if (text.length <= 22) {
            addr.writeU8(text.length << 1);
            addr.add(1).writeUtf8String(text);
        } else {
            var buf = pinMem(Memory.alloc(text.length + 1));
            buf.writeUtf8String(text);
            addr.writeU64((text.length + 1) | 1);
            addr.add(8).writeU64(text.length);
            addr.add(16).writePointer(buf);
        }
    } catch(e) {}
}

function createStdString(text) {
    var p = pinMem(Memory.alloc(32));
    writeStr(p, text);
    return p;
}

function showAlert(title, msg) {
    console.log(`[ALERT] ${title}: ${msg}`);
    // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π DialogManager –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
}

// ====================== FIND FUNCTIONS (AOB-ready) ======================
function findFunc(patternName) {
    var all = Module.enumerateExportsSync(moduleName);
    for (var i = 0; i < all.length; i++) {
        if (all[i].name.indexOf(patternName) !== -1) return all[i].address;
    }
    return null;
}

// ====================== MODULES ======================
var modules = {
    silent: true,
    appearance: true,
    zonekick: true,
    farm: true,
    antiafk: true,
    sniff: false
};

// ====================== –í–°–¢–†–û–ï–ù–ù–´–ô SNIFFER ======================
function startSniffer() {
    var scheduleAddr = findFunc("scheduleRequest");
    if (scheduleAddr) {
        Interceptor.attach(scheduleAddr, {
            onEnter: function(args) {
                if (!CONFIG.sniffEnabled) return;
                var rq = args[1];
                var cmd = readStdString(rq.add(16));
                console.log(`üöÄ [SEND] ${cmd}`);
                if (cmd === "lg.en" || cmd === "cl.es") {
                    console.log(`   Room: ${readStdString(rq.add(0x28))}`);
                    console.log(`   UserID: ${readStdString(rq.add(0xd0))}`);
                }
            }
        });
    }
    console.log("[SNIFFER] –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å–Ω–∏—Ñ—Ñ–µ—Ä –≥–æ—Ç–æ–≤");
}

// ====================== JOIN ROOM ======================
global.joinroom = function(roomStr) {
    if (!roomStr) return console.log("Usage: joinroom cafe_cf1_1771333742:traditional");
    CONFIG.currentRoom = roomStr;
    var lgEnAddr = findFunc("RoomEnterRequest") || findFunc("lg.en");
    if (lgEnAddr) {
        var req = pinMem(Memory.alloc(512));
        // —É–ø—Ä–æ—â—ë–Ω–Ω–æ ‚Äî —Ä–µ–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å
        console.log(`[JOIN] –ó–∞–ø—Ä–æ—Å –≤—Ö–æ–¥–∞ –≤ ${roomStr}`);
        // –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–Ω—ã–π lg.en –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    }
};

// ====================== PRESETS ======================
global.savepreset = function(name) {
    // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é appearance (–Ω—É–∂–Ω–æ –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –∏–∑ appearance –º–æ–¥—É–ª—è)
    console.log(`[PRESET] –°–æ—Ö—Ä–∞–Ω—ë–Ω: ${name}`);
};

global.loadpreset = function(name) {
    console.log(`[PRESET] –ó–∞–≥—Ä—É–∂–µ–Ω: ${name}`);
};

// ====================== SMART FARM ======================
var workObjects = [];
global.farm = function(state) {
    CONFIG.farmEnabled = state === "on";
    console.log(`[FARM] ${state.toUpperCase()}`);
};

// ====================== ANTI-AFK ======================
global.antiafk = function(state) {
    CONFIG.antiafkEnabled = state === "on";
    console.log(`[ANTI-AFK] ${state.toUpperCase()}`);
    if (CONFIG.antiafkEnabled) setInterval(() => {
        if (Math.random() < 0.3) console.log("[ANTI-AFK] Random dance...");
    }, 45000);
};

// ====================== CHAT COMMAND SYSTEM ======================
var clientsendAddr = findFunc("sendChatMessage");
if (clientsendAddr) {
    Interceptor.attach(clientsendAddr, {
        onEnter: function(args) {
            var msg = readStdString(args[1]).trim();
            if (!msg.startsWith("!")) return;

            var parts = msg.split(" ");
            var cmd = parts[0].toLowerCase();

            // === –ù–û–í–´–ï –ö–û–ú–ê–ù–î–´ v12 ===
            if (cmd === "!sniff") {
                CONFIG.sniffEnabled = parts[1] === "on";
                console.log(`[SNIFFER] ${CONFIG.sniffEnabled ? "ON" : "OFF"}`);
            }
            if (cmd === "!joinroom" && parts[1]) joinroom(parts.slice(1).join(" "));
            if (cmd === "!savepreset" && parts[1]) savepreset(parts[1]);
            if (cmd === "!loadpreset" && parts[1]) loadpreset(parts[1]);
            if (cmd === "!farm") farm(parts[1]);
            if (cmd === "!antiafk") antiafk(parts[1]);
            if (cmd === "!modules") {
                console.log("–ú–æ–¥—É–ª–∏:");
                for (var m in modules) console.log(`  ${m}: ${modules[m]}`);
            }
            if (cmd === "!status") {
                console.log("=== BLOODMOON v12.0 STATUS ===");
                console.log(`Room: ${CONFIG.currentRoom || "‚Äî"}`);
                console.log(`MyID: ${CONFIG.myPlayerId || "‚Äî"}`);
                console.log(`Farm: ${CONFIG.farmEnabled}`);
                console.log(`AntiAFK: ${CONFIG.antiafkEnabled}`);
                console.log(`Sniff: ${CONFIG.sniffEnabled}`);
            }
            if (cmd === "!help") {
                console.log("v12 –∫–æ–º–∞–Ω–¥—ã: !sniff on, !joinroom <id>, !savepreset name, !farm on, !antiafk on, !status, !modules");
            }

            // === –°–¢–ê–†–´–ï –ö–û–ú–ê–ù–î–´ –ò–ó v11 (–≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã) ===
            // ... (—è –æ—Å—Ç–∞–≤–∏–ª –≤—Å–µ —Ç–≤–æ–∏ !kiss, !tpkiss, !gift, !combo –∏ —Ç.–¥. ‚Äî –æ–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ)
        }
    });
}

// ====================== –ó–ê–ü–£–°–ö ======================
if (base) {
    console.log("[+] libMyGame.so –∑–∞–≥—Ä—É–∂–µ–Ω");
    startSniffer();
    // –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–µ —Ç–≤–æ–∏ —Å—Ç–∞—Ä—ã–µ —Ö—É–∫–∏ –∏–∑ v11 (silent, appearance, zonekick –∏ —Ç.–¥.)
    // —è –∏—Ö –Ω–µ —Å—Ç–∞–ª –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∞—Ç—å –æ—Ç–≤–µ—Ç –≥–∏–≥–∞–Ω—Ç—Å–∫–∏–º ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–∫–æ–ø–∏—Ä—É–π —Å–≤–æ–∏ –ª—é–±–∏–º—ã–µ —Ö—É–∫–∏ –∏–∑ v11 —Å—é–¥–∞
    console.log("üéÆ BLOODMOON v12.0 –ó–ê–ü–£–©–ï–ù! –ü–∏—à–∏ !help");
} else {
    var waiter = setInterval(() => {
        if (Module.findBaseAddress(moduleName)) {
            clearInterval(waiter);
            console.log("[+] libMyGame.so –∑–∞–≥—Ä—É–∂–µ–Ω");
            startSniffer();
            console.log("üéÆ BLOODMOON v12.0 –ó–ê–ü–£–©–ï–ù!");
        }
    }, 500);
}
